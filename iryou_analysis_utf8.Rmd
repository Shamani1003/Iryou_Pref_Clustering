---
title: 都道府県別データのクラスタリング分析
date: 2018年12月
author: 西山
---

## 初期設定とデータファイルの読み込み、標準化

今回の分析作業に必要なパッケージを先に読み込んでおく。

```{r echo=F,warning=TRUE,message=TRUE}
library(dplyr)
library(ggplot2)
library(FactoMineR)
library(fpc)
```

データファイルはCSVファイルとして保存されている。

```{r readdata,hold=TRUE}
iryou <- read.csv(file="Iryou-Pref.csv")
head(iryou)
```

まず都道府県の名"Pref"をケース名に設定する。なおOBSの授業『ビジネス統計分析』ではRコマンダーを利用している。同じ作業をコマンドを使って行うなら以下のようになる。この資料では実行コマンドを敢えて表示して勉強の便に資したい。

```{r case_name}
rownames(iryou) <- iryou$Pref
iryou$Pref <- NULL
```

最初にデータの要約をする。量的変量なら最大値と最小値、中央値や平均値を確認しておく。質的変量なら不審なラベルがないかどうかを見ておこう。

```{r summary}
summary(iryou)
```

直ちに分かるのは項目間でデータの大きさがかなり違うという点である。主成分はばらつきの大きなデータの影響を受ける。そこでデータをすべて**標準化**して、尺度を共通化しておくのが主成分分析の鉄則である。Ｒコマンダーでは「相関行列を使う」ことで実質的には同じことをしている。

コマンド"scale"で各列のデータを標準化できるが、そのままではマトリックス型の値になる。後で主成分得点をデータセットに簡単に追加できるようにするため、iryou.stdをデータフレーム型にしている　--- Rコマンダーでデータセットと呼んでいるのはデータフレーム型の値である。

```{r normalize}
iryou.std <- as.data.frame(scale(iryou))
```

**標準化**された数値を**標準値**と言う。この標準値は、統計分析で頻繁に使われる物差しになっている。受験でよく使われる**偏差値**も標準値から派生した尺度である。標準化をしてもデータの間の相関関係は変わらない。たとえば、身長と体重には正の相関がある―大きな人は背が高く、体重も重くなる傾向がある。実は、身長と体重を標準化しても相関係数は同じである。桁数の違いが大きいデータは扱いづらい。そんな時、単位を変えて桁数のバランスをとることが多いが、統計分析の場では標準化が最も頻繁にとられる尺度調整法になっている。

実際に、標準化されたデータの平均と分散を求めると、どの項目も平均が0、分散が1になっている。分散が1ということはその平方根である標準偏差も1である。

```{r normalizedscale}
apply(iryou.std,2,mean)
apply(iryou.std,2,var)
```

## 主成分分析

まず主成分分析を行う。Rコマンダーのメニューで主成分分析を選ぶとコマンド"princomp"が実行されるが、それよりは見やすいグラフを自動的に作成してくれるFactoMineRのPCAを使うことにする。Rコマンダーのプラグイン・ツール"RcmdrPlugin.FactoMineR"を利用しても同じである。

```{r pca}
pca <- PCA(iryou.std)
```

コマンド"PCA"を実行すると、第１主成分と第２主成分を散布図にプロットした図が自動的に作成され、プロっとされた個々の点に対応するケース名が表示されるので便利である。加えて、元の個別データと二つの主成分がどのように関連しているかも別の図に視覚化される。

図"Variables factor map (PCA)"をみると、元の個別データのほとんど全ては第１主成分に対してプラスの寄与をしていることが分かる（データD7「年間救急出動件数だけは僅かに負の寄与であるが）。第１主成分は元のデータ全体の単純平均ではないにしても、概念としては合計にかなり近いものと解釈される。

第１主成分に対して第２主成分のほうは個別データとの関連に正負の違いが出ている。大雑把にみて、D1からD14までの医療機関の数や利用状況は正の寄与を、D15より後の病院別死亡率に関するデータは負の寄与をしているようである。第２主成分は医療機関の供給状況と死亡率の状況のバランスを測っているものと先ずは解釈してよさそうである。

主成分分析のウィークポイントは、得られた主成分の意味解釈にあることは授業中に話したことではあるが、この辺は対応分析と併用するとよいかもしれない。

### 主成分得点のデータセットへの追加

FactoMineRの"PCA"コマンドは主成分得点を散布図に描いてくれるので大変便利であある。しかし、より掘り下げた分析を進めるには、やはり各都道府県の主成分得点をデータセットに追加しておきたい。それには以下のようにする。

まず主成分分析の結果を保存している"pca"の中身を確認する。

```{r look_pca}
names(pca)
```

色々な結果が保存されていることが分かるが、散布図を描くときに参照された座標値は結果"pca＄ind＄coord"の第１列"Dim.1"と第２列"Dim.2"であることが確認できる。実際、これらをそれぞれ"PC1"、"PC2"と名前をつけてデータセット"iryou.std"に追加し、散布図を描いてみると上と同じ散布図が得られる。

```{r add_pca_pc}
iryou.std$PC1 <- pca$ind$coord[,1]
iryou.std$PC2 <- pca$ind$coord[,2]
ggplot(iryou.std, aes(x=PC1,y=PC2)) +
  geom_point() +
  geom_text(aes(label=rownames(iryou.std)))
```

## クラスター分析

上で得られた二つの主成分（PC1とPC2）に基づいて、都道府県別医療状況のクラスター分析を行う。

OBSの授業「ビジネス統計分析」でも説明したとおり、クラスター分析には非階層型クラスタリングと階層型クラスタリングの二つの方法がある。

ここでは授業を復習する意味合いから、まず非階層型クラスタリングを行う。非階層型クラスタリングで大切な点は、第１にクラスタ数を指定しなければならないこと。第２はクラスターの種として最初にランダムにとられる何個かの点の選び方によって結果として得られるクラスター構成に違いがもたらされる、つまり実行するたびに異なった結果になる可能性があるということである。

### FROM HERE


```{r cluster}
clst<-kmeans(iryou.std[,c("pc1","pc2")],centers=4,iter.max=100)
```

結果の一覧は次のとおりである。

```{r cluster.kekka}
names(clst)
length(clst$cluster)
```

結果の中の"cluster"がグループ分けされた後、各都道府県に割り当てられたグループ番号である。これを元のデータ表に"cluster"という名前で追加してから、四つのクラスターで層別化して都道府県の散布図を描く。

```{r cluster.plot}
iryou.std$cluster <- clst$cluster
p.cluster <- ggplot(iryou.std,aes(x=pc1,y=pc2,col=factor(cluster)))
p.cluster <- p.cluster + geom_point()
p.cluster <- p.cluster + geom_text(aes(label=Pref,vjust=1))
p.cluster <- p.cluster+xlim(-8.5,8.5)
p.cluster <- p.cluster+theme_bw()
plot(p.cluster)
```


### （留意点）

上のクラスター分析から得られたクラスター別散布図は、おそらく履修者の皆がRコマンダーを用いて得たグラフとは違っていると予想する。つまり、散布図全体の形は同じであるものの、どの都道府県をどのグループに入れるかというクラスタリングが違う。そうなっているのではなかろうか。

参考までに西山がRコマンダーの主成分分析・クラスター分析から得た散布図を示しておく。Rが自動的につけるクラスター番号の違いに注意せよ。

![By R-Commander](iryou_plot_cluster.png)

Rコマンダーで繰り返し数を最大30にした時のクラスター１のメンバーは山口県、徳島県、高知県、佐賀県、鹿児島県の５県だった。他方、コマンドで分析し最大繰り返し数を100にした時には、更に複数の県が同じクラスターに加えられることが多い。

クラスター分析は（主成分分析とは違って）反復計算を通して収束解（＝これ以上動かぬ結果）を探す技法である。そのため、何回で計算を打ち切るかで違いが出る。更に、クラスター分析では最初にランダムに幾つかの都道府県をとって、これと近いデータを順にまとめていく技法である。従って、ランダムにとる初期値が異なるとその後のクラスタリングも変わってしまう。―こうした点がクラスター分析の（大きな）欠点として挙げられることは多い。

このような弱みがある一方で、得られたクラスターの特徴（＝プロファイル）を比べると、結局は同じ違いが引き出されていることに気がつくはずである。違いをまとめる便利な技術として、最近よく利用されるようになった。その位の気持ちで使っていくのが良い使い方だと思われる。

常に同じ解が得られないという点は、実はクラスター分析だけに言えることではなく、後で登場する分析ツールにも同様の性質をもったものがある。

計算のつど結果が大きく変わるのはビジネスツールとしては使いにくい。そのためRのパッケージの中では"ykmeans"がクラスタリングのツールとしては利用されているようである―パッケージのインストールはRコマンダーと同じ。これは（例えば）通常のクラスタリングを100回行い、その中から頻度の最も高い結果を採用する方法である。

さて、本論に戻る。

今回のクラスター分析の結果に基づき、各クラスターの特徴づけを行っておこう。特徴づけは標準値ではなく元データのほうが見やすいので、データセット"iryou"にクラスター番号を追加しておく。

```{r origdata_cluster}
iryou$cluster <- clst$cluster
colnames(iryou)
```

この資料では、コマンド利用によっているが特に層別化した統計量（特に平均値やメディアン）を出す作業ではRコマンダーを利用するほうが簡単だろうと思われる。

念のため、クラスター化したそれぞれのグループにどんな都道府県がメンバーとして含まれているかを表示しておこう。

```{r group_menber}
split(iryou$Pref,factor(iryou$cluster))
```

以下、クラスタリングが異なることを承知の上で、個別項目についてクラスター別平均値を見ていく。クラスターごとの特徴づけになると、Rコマンダーによる結果と大きな違いはなくなってくる（はずである）。実際、第１主成分・第２主成分の散布図全体としては同じであり、それをどう四つに分けるかという分け方は、基本的に同じポジショニングになっている。


# 医療施設、医師、看護師等の数

* D1: 一般病院数（10万人当たり）

```{r summary_d1}
iryou %>% group_by(cluster) %>% summarise(avgD1=mean(D1))
```

* D2: 一般診療所数（10万人当たり）

```{r summary_d2}
iryou %>% group_by(cluster) %>% summarise(avgD2=mean(D2))
```

* D3: 一般病院病床数（10万人当たり）

```{r summary_d3}
iryou %>% group_by(cluster) %>% summarise(avgD3=mean(D3))
```

* D4: 医療施設に従事する医師数（10万人当たり）

```{r summary_d4}
iryou %>% group_by(cluster) %>% summarise(avgD4=mean(D4))
```

* D5: 医療施設に従事する（准）看護師数（10万人当たり）

```{r summary_d5}
iryou %>% group_by(cluster) %>% summarise(avgD5=mean(D5))
```

* D6: 救急自動車数（10万人当たり）

```{r summary_d6}
iryou %>% group_by(cluster) %>% summarise(avgD6=mean(D6))
```

* D7: 年間救急出動件数（千人当たり）

```{r summary_d7}
iryou %>% group_by(cluster) %>% summarise(avgD7=mean(D7))
```

* D8: 薬局数（10万人当たり）

```{r summary_d8}
iryou %>% group_by(cluster) %>% summarise(avgD8=mean(D8))
```

### 医療サービスの供給サイドについては、全体として高知・山口など地方圏から構成されるクラスターの充実が見てとれる。反対に東京など大都市圏クラスターでは水準が低い。

# 患者数、利用率等

* D9: 一般病院外来患者数（常勤医師1人1日当たり）

```{r summary_d9}
iryou %>% group_by(cluster) %>% summarise(avgD9=mean(D9))
```

* D10: 一般病院在院患者数（常勤医師1人1日当たり）

```{r summary_d10}
iryou %>% group_by(cluster) %>% summarise(avgD10=mean(D10))
```

* D11: 一般病院在院患者数（看護師・准看護士1人1日当たり）

```{r summary_d11}
iryou %>% group_by(cluster) %>% summarise(avgD11=mean(D11))
```

* D12: 一般病院病床利用率

```{r summary_d12}
iryou %>% group_by(cluster) %>% summarise(avgD12=mean(D12))
```

* D13: 一般病院平均在院日数

```{r summary_d13}
iryou %>% group_by(cluster) %>% summarise(avgD13=mean(D13))
```

* D14: 一般病院年間新入院患者数

```{r summary_d14}
iryou %>% group_by(cluster) %>% summarise(avgD14=mean(D14))
```

### 需要サイドのうち、外来患者数は青森・秋田など主として寒冷地から構成されるクラスターが多い。他方、在院患者数、平均在院日数、新入院患者数などについては高知・山口など地方圏から構成されるクラスターの水準が高い。東京など大都市圏クラスターでは平均在院日数が短いなど予想通りの結果がみられる。

# 病因別死亡率等

* D15: 標準化死亡率（千人当たり）

```{r summary_d15}
iryou %>% group_by(cluster) %>% summarise(avgD15=mean(D15))
```

* D16: 生活習慣病による死亡者数（10万人当たり）

```{r summary_d16}
iryou %>% group_by(cluster) %>% summarise(avgD16=mean(D16))
```

* D17: 悪性新生物による死亡者数（10万人当たり）

```{r summary_d17}
iryou %>% group_by(cluster) %>% summarise(avgD17=mean(D17))
```

* D18: 糖尿病による死亡者数（10万人当たり）

```{r summary_d18}
iryou %>% group_by(cluster) %>% summarise(avgD18=mean(D18))
```

* D19: 高血圧疾患による死亡者数（10万人当たり）

```{r summary_d19}
iryou %>% group_by(cluster) %>% summarise(avgD19=mean(D19))
```

* D20: 心疾患（高血圧を除く）による死亡者数（10万人当たり）

```{r summary_d20}
iryou %>% group_by(cluster) %>% summarise(avgD20=mean(D20))
```

* D21: 脳血管疾患による死亡者数（10万人当たり）

```{r summary_d21}
iryou %>% group_by(cluster) %>% summarise(avgD21=mean(D21))
```

* D22: 自殺者数（10万人当たり）

```{r summary_d22}
iryou %>% group_by(cluster) %>% summarise(avgD22=mean(D22))
```

### 各病因を通して、青森・秋田等の寒冷地クラスターと高知・山口島の地方圏クラスターの相対的な高さがみてとれる。

### この資料では四つのクラスターに分けたが、中途半端な分け方になっている印象もある。クラスター数を３、例えば上の結果をみれば「大都市クラスター」、「地方圏クラスター」、「東北・北陸クラスター」で医療状況をグループ分けするのが適切かもしれない。作業は自習課題とし、ここでは省略する。『どちらのクラスター分けが正しいのか』という問いかけよりも、分けた時に見てとれる違いは「役に立つ違いか」を考えるべし。

